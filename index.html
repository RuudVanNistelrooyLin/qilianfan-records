<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ä¸ƒè¿ç¿»è®¡åˆ†æ¿</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      padding: 20px;
      background-color: #f7f7f7;
      color: #333;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background-color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: center;
    }
    th {
      background-color: #4CAF50;
      color: white;
      position: sticky;
      top: 0;
    }
    td input {
      width: 90%;
      padding: 6px;
      border: 1px solid #ccc;
      border-radius: 4px;
      text-align: center;
    }
    .player-name {
      font-weight: bold;
      background-color: #f0f0f0;
    }
    .total-row {
      background-color: #e8f5e8;
      font-weight: bold;
    }
    .add-row-btn {
      display: block;
      margin: 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .add-row-btn:hover {
      background-color: #45a049;
    }
    .empty-tip {
      text-align: center;
      color: #999;
      margin: 40px 0;
      font-style: italic;
    }
    .add-player {
      width: 90%;
      padding: 8px;
      margin: 5px 0;
      border: 1px dashed #4CAF50;
      text-align: center;
      color: #4CAF50;
      background: none;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>ğŸ² ä¸ƒè¿ç¿»è®¡åˆ†æ¿</h1>

  <table id="scoreTable">
    <thead>
      <tr id="headerRow"></tr>
    </thead>
    <tbody id="scoreBody"></tbody>
  </table>

  <button class="add-row-btn" onclick="addScoreRow()">+ æ–°å¢ä¸€å±€</button>

  <script>
    // å­˜å‚¨é”®å
    const STORAGE_KEY = 'qilianfan_scores_v1';

    // é»˜è®¤æ•°æ®ç»“æ„
    let gameData = {
      players: ['ç©å®¶1', 'ç©å®¶2'], // é»˜è®¤ä¸¤ä¸ªç©å®¶
      scores: [] // æ¯è¡Œå¾—åˆ†ï¼Œscores[i][j] è¡¨ç¤ºç¬¬iå±€ç¬¬jä¸ªç©å®¶çš„å¾—åˆ†
    };

    // ä» localStorage åŠ è½½æ•°æ®
    function loadFromStorage() {
      const saved = localStorage.getItem(STORAGE_KEY);
      if (saved) {
        try {
          const parsed = JSON.parse(saved);
          // éªŒè¯æ•°æ®ç»“æ„
          if (parsed.players && Array.isArray(parsed.players) && parsed.scores && Array.isArray(parsed.scores)) {
            gameData = parsed;
          }
        } catch (e) {
          console.warn('Failed to parse saved data', e);
        }
      }
    }

    // ä¿å­˜åˆ° localStorage
    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(gameData));
    }

    // æ¸²æŸ“è¡¨å¤´ï¼ˆç©å®¶åˆ—ï¼‰
    function renderHeader() {
      const headerRow = document.getElementById('headerRow');
      headerRow.innerHTML = '<th>å±€æ•°</th>';
      
      gameData.players.forEach((name, index) => {
        const th = document.createElement('th');
        const input = document.createElement('input');
        input.type = 'text';
        input.value = name;
        input.className = 'player-name';
        input.dataset.index = index;
        input.addEventListener('change', function() {
          gameData.players[index] = this.value.trim() || `ç©å®¶${index + 1}`;
          saveToStorage();
          render();
        });
        th.appendChild(input);
        headerRow.appendChild(th);
      });
    }

    // æ¸²æŸ“æ‰€æœ‰å¾—åˆ†è¡Œ
    function renderScoreRows() {
      const tbody = document.getElementById('scoreBody');
      tbody.innerHTML = '';

      // æ¸²æŸ“æ¯ä¸€å±€çš„å¾—åˆ†
      gameData.scores.forEach((row, rowIndex) => {
        const tr = document.createElement('tr');
        
        // å±€æ•°åˆ—
        const roundTd = document.createElement('td');
        roundTd.textContent = `ç¬¬${rowIndex + 1}å±€`;
        tr.appendChild(roundTd);

        // æ¯ä¸ªç©å®¶çš„å¾—åˆ†è¾“å…¥æ¡†
        gameData.players.forEach((player, playerIndex) => {
          const td = document.createElement('td');
          const input = document.createElement('input');
          input.type = 'number';
          input.value = row[playerIndex] !== undefined ? row[playerIndex] : '';
          input.dataset.row = rowIndex;
          input.dataset.col = playerIndex;
          input.addEventListener('change', function() {
            const row = parseInt(this.dataset.row);
            const col = parseInt(this.dataset.col);
            const value = this.value.trim();
            gameData.scores[row][col] = value ? parseInt(value) || 0 : 0;
            saveToStorage();
            updateTotalRow();
          });
          td.appendChild(input);
          tr.appendChild(td);
        });

        tbody.appendChild(tr);
      });

      // æ·»åŠ â€œæ·»åŠ ç©å®¶â€æŒ‰é’®è¡Œ
      const addPlayerTr = document.createElement('tr');
      const addPlayerTd = document.createElement('td');
      addPlayerTd.colSpan = gameData.players.length + 1;
      const addPlayerBtn = document.createElement('button');
      addPlayerBtn.textContent = '+ æ·»åŠ ç©å®¶';
      addPlayerBtn.className = 'add-player';
      addPlayerBtn.onclick = addPlayer;
      addPlayerTd.appendChild(addPlayerBtn);
      addPlayerTr.appendChild(addPlayerTd);
      tbody.appendChild(addPlayerTr);

      // æ¸²æŸ“æ€»åˆ†è¡Œ
      renderTotalRow();
    }

    // æ¸²æŸ“æ€»åˆ†è¡Œ
    function renderTotalRow() {
      const tbody = document.getElementById('scoreBody');
      const totalTr = document.createElement('tr');
      totalTr.className = 'total-row';
      
      const totalTd = document.createElement('td');
      totalTd.textContent = 'æ€»åˆ†';
      totalTr.appendChild(totalTd);

      // è®¡ç®—æ¯ä¸ªç©å®¶çš„æ€»åˆ†
      gameData.players.forEach((player, playerIndex) => {
        const td = document.createElement('td');
        const total = gameData.scores.reduce((sum, row) => {
          const score = row[playerIndex];
          return sum + (score !== undefined ? score : 0);
        }, 0);
        td.textContent = total;
        totalTr.appendChild(td);
      });

      tbody.appendChild(totalTr);
    }

    // æ›´æ–°æ€»åˆ†è¡Œï¼ˆä¸é‡æ–°æ¸²æŸ“æ•´ä¸ªè¡¨æ ¼ï¼‰
    function updateTotalRow() {
      const rows = document.getElementById('scoreBody').children;
      const totalTr = rows[rows.length - 1]; // æœ€åä¸€è¡Œæ˜¯æ€»åˆ†è¡Œ
      
      // æ›´æ–°æ¯ä¸ªç©å®¶çš„æ€»åˆ†
      gameData.players.forEach((player, playerIndex) => {
        const total = gameData.scores.reduce((sum, row) => {
          const score = row[playerIndex];
          return sum + (score !== undefined ? score : 0);
        }, 0);
        totalTr.children[playerIndex + 1].textContent = total;
      });
    }

    // æ–°å¢ä¸€å±€å¾—åˆ†
    function addScoreRow() {
      const newRow = new Array(gameData.players.length).fill('');
      gameData.scores.push(newRow);
      saveToStorage();
      render();
    }

    // æ–°å¢ç©å®¶
    function addPlayer() {
      const newPlayerName = `ç©å®¶${gameData.players.length + 1}`;
      gameData.players.push(newPlayerName);
      
      // ä¸ºå·²æœ‰å±€æ•°æ·»åŠ æ–°ç©å®¶çš„å¾—åˆ†ä½
      gameData.scores.forEach(row => {
        row.push('');
      });

      saveToStorage();
      render();
    }

    // ä¸»æ¸²æŸ“å‡½æ•°
    function render() {
      renderHeader();
      renderScoreRows();
    }

    // åˆå§‹åŒ–
    function init() {
      loadFromStorage();
      render();

      // å¦‚æœæ²¡æœ‰æ•°æ®ï¼Œåˆå§‹åŒ–é»˜è®¤
      if (gameData.scores.length === 0) {
        addScoreRow(); // é»˜è®¤æ·»åŠ ä¸€å±€
      }
    }

    // é¡µé¢åŠ è½½å®Œæˆ
    window.addEventListener('load', init);
  </script>
</body>
</html>